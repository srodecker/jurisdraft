<!doctype html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JurisDraft - Legal Workspace</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/design-system.css" />
    <style>
        html, body {
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .workspace-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>
    <div class="workspace-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Header -->
            <div class="app-header">
                <a href="/" class="app-logo">
                    <div class="app-logo-icon">
                        <svg width="20" height="20" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="gavelGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#e0e7ff;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect x="35" y="20" width="8" height="50" rx="4" fill="url(#gavelGrad)"/>
                            <rect x="20" y="15" width="38" height="12" rx="6" fill="url(#gavelGrad)"/>
                            <rect x="20" y="15" width="12" height="25" rx="6" fill="url(#gavelGrad)"/>
                            <rect x="10" y="65" width="60" height="12" rx="6" fill="url(#gavelGrad)"/>
                            <rect x="10" y="65" width="12" height="20" rx="6" fill="url(#gavelGrad)"/>
                        </svg>
                    </div>
                    <div>
                        <div class="app-logo-text">JurisDraft</div>
                        <div class="app-logo-subtitle">Legal Workspace</div>
                    </div>
                </a>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                        <svg class="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <svg class="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </button>
                    <a href="/" class="home-link">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        Home
                    </a>
                </div>
            </div>

            <!-- Workflow Stepper -->
            <div class="workflow-stepper">
                <div class="step" id="step1">
                    <span class="step-number">1</span>
                    <span>Upload</span>
                </div>
                <div class="step-connector" id="connector1"></div>
                <div class="step" id="step2">
                    <span class="step-number">2</span>
                    <span>Extract</span>
                </div>
                <div class="step-connector" id="connector2"></div>
                <div class="step" id="step3">
                    <span class="step-number">3</span>
                    <span>Generate</span>
                </div>
            </div>

            <!-- Extract Section -->
            <div class="sidebar-section">
                <h2 class="sidebar-header">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: -2px; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Extract Data
                </h2>

                <div id="drop" class="upload-zone">
                    <svg class="upload-zone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="upload-zone-text">Drop files or click to select</p>
                    <button id="selectBtn" type="button" class="btn btn-primary btn-sm">
                        Select Files
                    </button>
                </div>

                <input id="fileInput" type="file" multiple style="display:none" />
                <div id="filesList"></div>

                <button id="uploadBtn" disabled class="btn btn-primary btn-full mt-3">
                    <span id="uploadBtnText">Upload & Extract</span>
                </button>

                <div id="extractNote"></div>
            </div>

            <!-- Template Selection -->
            <div class="sidebar-section">
                <h2 class="sidebar-header">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: -2px; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Template
                </h2>
                <select id="templateSelect" class="form-select">
                    <option value="">Loading templates...</option>
                </select>
            </div>

            <!-- JSON Input -->
            <div class="sidebar-section" style="flex: 1;">
                <h2 class="sidebar-header">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: -2px; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                    </svg>
                    JSON Data
                </h2>
                <textarea id="jsonInput" class="form-textarea code" rows="10" placeholder='Enter JSON data, e.g.:
{
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com"
}'></textarea>

                <div class="tip-box mt-3">
                    <strong>Tip:</strong> Field names in your JSON should match the form field names in the PDF.
                </div>

                <button id="checkCourtBtn" class="btn btn-secondary btn-full mt-3">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: -3px; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Check Court
                </button>
                <div id="courtStatus"></div>
            </div>

            <!-- Action Buttons -->
            <div class="sidebar-section">
                <div class="flex flex-col gap-2">
                    <button id="fillBtn" disabled class="btn btn-primary btn-full">
                        <span id="fillBtnText">Generate PDF</span>
                    </button>

                    <button id="autoFillBtn" disabled class="btn btn-secondary btn-full">
                        Auto Test Fill
                    </button>

                    <button id="submitBtn" disabled class="btn btn-secondary btn-full">
                        Submit Additional JSON
                    </button>

                    <div class="flex gap-2 mt-2">
                        <button id="downloadBtn" disabled class="btn btn-warning btn-full">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Download
                        </button>
                        <button id="downloadCourtBtn" disabled class="btn btn-success btn-full">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Court Ready
                        </button>
                    </div>
                </div>

                <div id="statusMessage"></div>
                <div id="fieldStats" class="mt-3 text-center"></div>
            </div>
        </aside>

        <!-- Main PDF Workspace -->
        <main class="main-workspace">
            <div id="pdfViewer" class="pdf-container">
                <div class="pdf-placeholder">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p style="font-size: 16px; font-weight: 500;">PDF Preview</p>
                    <p style="font-size: 13px; margin-top: 4px;">Select a template and click "Generate PDF" to preview</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Court Selection Modal -->
    <div id="courtModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: -4px; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Court Selection Required
                </h3>
                <button id="closeModalBtn" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">This ZIP code has multiple court options based on location. Please select the correct court:</p>
                <div id="courtOptionsContainer" class="court-options"></div>
            </div>
        </div>
    </div>

    <style>
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .modal-body {
            padding: 20px;
        }
        .modal-description {
            margin: 0 0 16px 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .court-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .court-option-btn {
            display: block;
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .court-option-btn:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }
        .court-option-btn.recommended {
            border-color: var(--accent-color);
            border-width: 2px;
            background: rgba(59, 130, 246, 0.1);
        }
        .court-option-btn.recommended:hover {
            background: var(--accent-color);
        }
        .recommended-badge {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
        }
        .court-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
        }
        .court-status-success {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        .court-status-warning {
            background: rgba(234, 179, 8, 0.15);
            color: #eab308;
        }
        .court-status-pending {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }
    </style>

    <script>
    // ===== THEME TOGGLE =====
    function getPreferredTheme() {
        const stored = localStorage.getItem('theme');
        if (stored) return stored;
        return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    }

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    }

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        setTheme(next);
    }

    // Initialize theme
    setTheme(getPreferredTheme());

    // ===== WORKFLOW STEPPER =====
    function updateWorkflowStep(step) {
        const steps = ['step1', 'step2', 'step3'];
        const connectors = ['connector1', 'connector2'];

        steps.forEach((s, i) => {
            const el = document.getElementById(s);
            el.classList.remove('active', 'completed');
            if (i + 1 < step) {
                el.classList.add('completed');
            } else if (i + 1 === step) {
                el.classList.add('active');
            }
        });

        connectors.forEach((c, i) => {
            const el = document.getElementById(c);
            el.classList.remove('completed');
            if (i + 1 < step) {
                el.classList.add('completed');
            }
        });
    }

    // Initialize workflow
    updateWorkflowStep(1);

    // ===== EXTRACT FUNCTIONALITY =====
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');
    const selectBtn = document.getElementById('selectBtn');
    const filesList = document.getElementById('filesList');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadBtnText = document.getElementById('uploadBtnText');
    const extractNote = document.getElementById('extractNote');

    let files = [];

    selectBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        fileInput.click();
    });

    drop.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));

    ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, (e) => {
        e.preventDefault();
        e.stopPropagation();
        drop.classList.add('dragover');
    }));

    ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, (e) => {
        e.preventDefault();
        e.stopPropagation();
        drop.classList.remove('dragover');
    }));

    drop.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        if (dt && dt.files) {
            handleFiles(Array.from(dt.files));
        }
    });

    function handleFiles(newFiles) {
        for (const f of newFiles) {
            const key = f.name + ":" + f.size;
            if (!files.some(x => x._key === key)) {
                f._key = key;
                files.push(f);
            }
        }
        renderFiles();
        if (files.length > 0) {
            updateWorkflowStep(1);
        }
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            pdf: 'PDF',
            doc: 'DOC', docx: 'DOC',
            txt: 'TXT',
            jpg: 'IMG', jpeg: 'IMG', png: 'IMG', gif: 'IMG',
            xls: 'XLS', xlsx: 'XLS', csv: 'CSV'
        };
        return icons[ext] || 'FILE';
    }

    function renderFiles() {
        filesList.innerHTML = '';
        files.forEach((f, i) => {
            const el = document.createElement('div');
            el.className = 'file-card';
            el.innerHTML = `
                <div class="file-card-icon">${getFileIcon(f.name)}</div>
                <div class="file-card-info">
                    <div class="file-card-name">${escapeHtml(f.name)}</div>
                    <div class="file-card-size">${formatFileSize(f.size)}</div>
                </div>
                <button data-i="${i}" class="file-card-remove">&#10005;</button>
            `;
            filesList.appendChild(el);
        });

        Array.from(filesList.querySelectorAll('.file-card-remove')).forEach(btn => {
            btn.addEventListener('click', (e) => {
                const i = Number(e.target.getAttribute('data-i'));
                files.splice(i, 1);
                renderFiles();
            });
        });

        uploadBtn.disabled = files.length === 0;
    }

    function escapeHtml(s) {
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    uploadBtn.addEventListener('click', async () => {
        if (files.length === 0) return;

        uploadBtn.disabled = true;
        uploadBtnText.innerHTML = '<span class="spinner"></span> Extracting...';
        showExtractStatus('Uploading and extracting...', 'info');

        const form = new FormData();
        for (const f of files) form.append('files', f, f.name);

        try {
            const res = await fetch('/api/extract', { method: 'POST', body: form });

            const contentType = res.headers.get('content-type') || '';
            let data;
            if (contentType.includes('application/json')) {
                data = await res.json();
            } else {
                const text = await res.text();
                console.error('Non-JSON response from /api/extract:', text);

                if (res.status === 503 && (text.includes('deployment is currently unavailable') || text.includes('SERVICE_UNAVAILABLE') || text.includes('sfo1::') || text.includes('iad1::') || text.includes('hnd1::') || text.includes('cle1::'))) {
                    const isVercelTimeout = text.includes('sfo1::') || text.includes('iad1::') || text.includes('hnd1::') || text.includes('cle1::');
                    const errorMsg = isVercelTimeout
                        ? 'VERCEL TIMEOUT: The request exceeded the function timeout limit. Try smaller/simpler documents or upgrade to Vercel Pro for longer timeouts.'
                        : 'Request timed out. Try smaller documents or try again.';
                    throw new Error(errorMsg);
                }

                throw new Error('Server returned non-JSON response. Check console.');
            }

            if (!res.ok) throw new Error(data.error || 'Extraction failed');

            if (data.generated) {
                let txt = data.generated;
                let jsonString = null;

                try {
                    jsonString = JSON.parse(txt);
                } catch (e) {
                    const match = txt.match(/\{[\s\S]*\}/m);
                    if (match) {
                        try { jsonString = JSON.parse(match[0]); }
                        catch (ee) { /* fall through */ }
                    }
                }

                if (jsonString && jsonString.error) {
                    console.error('Gemini API Error:', jsonString.error);
                    showExtractStatus(`API Error: ${escapeHtml(jsonString.error.message || 'Unknown error')}`, 'error');
                    uploadBtn.disabled = false;
                    uploadBtnText.textContent = 'Upload & Extract';
                    return;
                }

                if (jsonString) {
                    jsonInput.value = JSON.stringify(jsonString, null, 2);
                    showExtractStatus('Data extracted successfully! Now select a template and generate PDF.', 'success');
                    updateWorkflowStep(2);

                    uploadBtn.disabled = false;
                    uploadBtnText.textContent = 'Upload & Extract';

                    files = [];
                    renderFiles();
                    return;
                }

                showExtractStatus('Warning: The model returned text that is not valid JSON.', 'error');
                uploadBtn.disabled = false;
                uploadBtnText.textContent = 'Upload & Extract';
                return;
            }

            const preview = data.promptPreview ? data.promptPreview : JSON.stringify(data.files || data, null, 2);
            jsonInput.value = JSON.stringify({ note: data.note || 'No API key', preview }, null, 2);
            showExtractStatus('Data prepared (no API key detected)', 'info');

        } catch (err) {
            console.error(err);
            showExtractStatus(`Error: ${escapeHtml(err.message)}`, 'error');
        } finally {
            uploadBtn.disabled = false;
            uploadBtnText.textContent = 'Upload & Extract';
        }
    });

    function showExtractStatus(message, type = 'info') {
        extractNote.innerHTML = `<div class="status-box status-${type}">${message}</div>`;
    }

    // ===== PDF FILL FUNCTIONALITY =====
    const templateSelect = document.getElementById('templateSelect');
    const jsonInput = document.getElementById('jsonInput');
    const fillBtn = document.getElementById('fillBtn');
    const fillBtnText = document.getElementById('fillBtnText');
    const submitBtn = document.getElementById('submitBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadCourtBtn = document.getElementById('downloadCourtBtn');
    const pdfViewer = document.getElementById('pdfViewer');
    const statusMessage = document.getElementById('statusMessage');
    const fieldStats = document.getElementById('fieldStats');
    const autoFillBtn = document.getElementById('autoFillBtn');

    let currentPDFData = null;
    let currentPDFUrl = null;

    async function loadTemplates() {
        try {
            const response = await fetch('/api/templates');
            const data = await response.json();

            templateSelect.innerHTML = '<option value="">-- Select a PDF Template --</option>';

            if (data.templates && data.templates.length > 0) {
                data.templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template;
                    option.textContent = template;
                    templateSelect.appendChild(option);
                });
            } else {
                templateSelect.innerHTML = '<option value="">No templates found</option>';
                showStatus('No PDF templates found in the templates folder', 'error');
            }
        } catch (error) {
            console.error('Error loading templates:', error);
            showStatus('Failed to load templates', 'error');
            templateSelect.innerHTML = '<option value="">Error loading templates</option>';
        }
    }

    templateSelect.addEventListener('change', () => {
        const hasTemplate = !!templateSelect.value;
        fillBtn.disabled = !hasTemplate;
        autoFillBtn.disabled = !hasTemplate;
    });

    async function fillPDF() {
        const templateName = templateSelect.value;
        const jsonData = jsonInput.value.trim();

        if (!templateName) {
            showStatus('Please select a PDF template', 'error');
            return;
        }

        if (!jsonData) {
            showStatus('Please enter JSON data', 'error');
            return;
        }

        try {
            JSON.parse(jsonData);
        } catch (e) {
            showStatus('Invalid JSON format: ' + e.message, 'error');
            return;
        }

        fillBtn.disabled = true;
        fillBtnText.innerHTML = '<span class="spinner"></span> Processing...';
        showStatus('Processing PDF...', 'info');

        try {
            const response = await fetch('/api/fill-pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    templateName,
                    jsonData
                })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Failed to fill PDF');
            }

            currentPDFData = result.pdfData;

            if (currentPDFUrl) {
                URL.revokeObjectURL(currentPDFUrl);
            }

            const blob = base64ToBlob(result.pdfData, 'application/pdf');
            currentPDFUrl = URL.createObjectURL(blob);
            pdfViewer.innerHTML = `<iframe src="${currentPDFUrl}" class="no-transition"></iframe>`;

            showStatus(`PDF filled successfully! ${result.filledFields} of ${result.totalFields} fields filled.`, 'success');
            updateWorkflowStep(3);

            let fieldStatsHTML = `<span class="field-stats">${result.filledFields}/${result.totalFields} fields filled</span>`;

            if (result.processedData && result.processedData['[ZIP_NOT_FOUND]'] === true) {
                const debtorZip = result.processedData['[DEBTOR1_ZIP]'] || 'unknown';
                fieldStatsHTML += `<br><span class="badge badge-warning mt-2">Zip ${debtorZip} not found</span>`;
            }

            fieldStats.innerHTML = fieldStatsHTML;

            downloadBtn.disabled = false;
            downloadCourtBtn.disabled = false;
            submitBtn.disabled = false;

            if (result.availableFields && result.availableFields.length > 0) {
                console.log('Available form fields:');
                result.availableFields.forEach(field => {
                    console.log(`- ${field.name} (${field.type})`);
                });
            }
        } catch (error) {
            console.error('Error filling PDF:', error);
            showStatus('Error: ' + error.message, 'error');
        } finally {
            fillBtn.disabled = false;
            fillBtnText.textContent = 'Generate PDF';
        }
    }

    async function autoFillPDF() {
        const templateName = templateSelect.value;

        if (!templateName) {
            showStatus('Please select a PDF template', 'error');
            return;
        }

        autoFillBtn.disabled = true;
        showStatus('Running auto test fill...', 'info');

        try {
            const response = await fetch('/api/auto-fill-pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ templateName })
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
                throw new Error(result.error || 'Failed to auto fill PDF');
            }

            currentPDFData = result.pdfData;

            if (currentPDFUrl) {
                URL.revokeObjectURL(currentPDFUrl);
            }

            const blob = base64ToBlob(result.pdfData, 'application/pdf');
            currentPDFUrl = URL.createObjectURL(blob);
            pdfViewer.innerHTML = `<iframe src="${currentPDFUrl}" class="no-transition"></iframe>`;

            showStatus(`Auto fill completed. ${result.filledFields} of ${result.totalFields} fields filled.`, 'success');
            updateWorkflowStep(3);

            fieldStats.innerHTML = `<span class="field-stats">${result.filledFields}/${result.totalFields} fields (auto)</span>`;

            downloadBtn.disabled = false;
            downloadCourtBtn.disabled = false;
            submitBtn.disabled = false;
        } catch (error) {
            console.error('Error in auto-fill:', error);
            showStatus('Error: ' + error.message, 'error');
        } finally {
            autoFillBtn.disabled = false;
        }
    }

    async function submitAdditionalJSON() {
        await fillPDF();
    }

    function downloadPDF() {
        if (!currentPDFData) {
            showStatus('No PDF available for download', 'error');
            return;
        }

        try {
            const blob = base64ToBlob(currentPDFData, 'application/pdf');
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'JurisDraft_Filing.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            showStatus('Download started!', 'success');
        } catch (error) {
            console.error('Download error:', error);
            showStatus('Download failed: ' + error.message, 'error');
        }
    }

    function downloadCourtReadyPDF() {
        if (!currentPDFData) {
            showStatus('No court-ready PDF available for download', 'error');
            return;
        }

        try {
            const blob = base64ToBlob(currentPDFData, 'application/pdf');
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'JurisDraft_Court_Ready.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            showStatus('Court-ready PDF download started!', 'success');
        } catch (error) {
            console.error('Download error:', error);
            showStatus('Download failed: ' + error.message, 'error');
        }
    }

    function base64ToBlob(base64, mimeType) {
        const byteCharacters = atob(base64);
        const byteArrays = [];

        for (let offset = 0; offset < byteCharacters.length; offset += 512) {
            const slice = byteCharacters.slice(offset, offset + 512);
            const byteNumbers = new Array(slice.length);

            for (let i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            const byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
        }

        return new Blob(byteArrays, { type: mimeType });
    }

    function showStatus(message, type = 'info') {
        statusMessage.innerHTML = `<div class="status-box status-${type}">${message}</div>`;
    }

    window.addEventListener('beforeunload', () => {
        if (currentPDFUrl) {
            URL.revokeObjectURL(currentPDFUrl);
        }
    });

    fillBtn.addEventListener('click', fillPDF);
    submitBtn.addEventListener('click', submitAdditionalJSON);
    downloadBtn.addEventListener('click', downloadPDF);
    downloadCourtBtn.addEventListener('click', downloadCourtReadyPDF);
    autoFillBtn.addEventListener('click', autoFillPDF);

    loadTemplates();

    // ===== COURT LOOKUP FUNCTIONALITY =====
    const checkCourtBtn = document.getElementById('checkCourtBtn');
    const courtStatus = document.getElementById('courtStatus');
    const courtModal = document.getElementById('courtModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const courtOptionsContainer = document.getElementById('courtOptionsContainer');

    // Close modal when clicking close button or outside
    closeModalBtn.addEventListener('click', () => {
        courtModal.style.display = 'none';
    });

    courtModal.addEventListener('click', (e) => {
        if (e.target === courtModal) {
            courtModal.style.display = 'none';
        }
    });

    // Parse JSON from textarea safely
    function getJsonData() {
        try {
            return JSON.parse(jsonInput.value.trim());
        } catch (e) {
            return null;
        }
    }

    // Update JSON in textarea
    function updateJsonData(data) {
        jsonInput.value = JSON.stringify(data, null, 2);
    }

    // Show court status message
    function showCourtStatus(message, type = 'pending') {
        courtStatus.innerHTML = `<div class="court-status court-status-${type}">${message}</div>`;
    }

    // Clear court status
    function clearCourtStatus() {
        courtStatus.innerHTML = '';
    }

    // Check court based on current JSON data
    async function checkCourt(citySelection = null) {
        const data = getJsonData();
        if (!data) {
            showCourtStatus('‚ö† Invalid JSON - cannot check court', 'warning');
            return;
        }

        const zip = data['[DEBTOR1_ZIP]'] || '';
        const amount = data['[DEMAND_AMOUNT]'] || data['[JUDGMENT_TOTAL_AMOUNT]'] || '';

        if (!zip) {
            showCourtStatus('‚ö† No ZIP code found in data', 'warning');
            return;
        }

        showCourtStatus('üîç Looking up court...', 'pending');

        try {
            let url = `/api/court-lookup?zip=${encodeURIComponent(zip)}&amount=${encodeURIComponent(amount)}`;
            if (citySelection) {
                url += `&citySelection=${encodeURIComponent(citySelection)}`;
            }

            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                // Court found - show success and update JSON
                const caseTypeLabel = result.caseType === 'limited' ? 'Limited' : 'Unlimited';
                showCourtStatus(`‚úì ${result.courtName} (${caseTypeLabel})`, 'success');

                // Update JSON with court info
                data['[COURT_CITY_SELECTION]'] = citySelection || '';
                data['[VAR_COURTHOUSE]'] = result.courtName;
                data['[COURT_BRANCH_NAME]'] = result.courtName;
                if (result.courtAddress) {
                    data['[VAR_COURT_INFO]'] = result.courtAddress;
                }
                if (result.courtDistrict) {
                    data['[COURT_DISTRICT]'] = result.courtDistrict;
                }
                updateJsonData(data);

                // Hide modal if open
                courtModal.style.display = 'none';

            } else if (result.needsSelection) {
                // Multiple options - show modal
                const statusMsg = result.type === 'split' ? '‚ö† Location verification required' : '‚ö† Court selection available';
                showCourtStatus(statusMsg, 'warning');
                showCourtSelectionModal(result);

            } else if (result.error) {
                showCourtStatus(`‚ö† ${result.error}`, 'warning');
            }
        } catch (error) {
            console.error('Court lookup error:', error);
            showCourtStatus('‚ö† Court lookup failed', 'warning');
        }
    }

    // Show the court selection modal with options
    function showCourtSelectionModal(result) {
        const { options, caseType, type, defaultOption } = result;
        const caseTypeLabel = caseType === 'limited' ? 'Limited' : 'Unlimited';
        const isSplit = type === 'split';

        // Update modal title and description based on type
        const modalTitle = document.querySelector('.modal-title');
        const modalDescription = document.querySelector('.modal-description');

        if (isSplit) {
            modalTitle.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: -4px; margin-right: 8px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Location Verification Required
            `;
            modalDescription.textContent = "The ZIP code provided falls into multiple jurisdictions based on specific location. Please select the description that matches the defendant's location:";
        } else {
            modalTitle.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: -4px; margin-right: 8px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                Select Filing Court
            `;
            modalDescription.textContent = "Multiple permissible filing venues were found. We recommend the following, but you may select an alternative:";
        }

        courtOptionsContainer.innerHTML = '';

        options.forEach(option => {
            const btn = document.createElement('button');
            const isRecommended = !isSplit && option === defaultOption;
            btn.className = 'court-option-btn' + (isRecommended ? ' recommended' : '');

            if (isSplit) {
                // Geographic split - show condition/location description
                btn.innerHTML = `
                    <strong>${escapeHtml(option)}</strong>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                        ${caseTypeLabel} Case
                    </div>
                `;
            } else {
                // Venue choice - show court name with optional recommended badge
                btn.innerHTML = `
                    <strong>${escapeHtml(option)}${isRecommended ? '<span class="recommended-badge">Recommended</span>' : ''}</strong>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                        ${caseTypeLabel} Case
                    </div>
                `;
            }

            btn.addEventListener('click', () => {
                handleCourtSelection(option);
            });
            courtOptionsContainer.appendChild(btn);
        });

        courtModal.style.display = 'flex';
    }

    // Handle court option selection
    function handleCourtSelection(selectedCity) {
        // Update JSON with selection
        const data = getJsonData();
        if (data) {
            data['[COURT_CITY_SELECTION]'] = selectedCity;
            updateJsonData(data);
        }

        // Re-run lookup with selection
        checkCourt(selectedCity);
    }

    // Check Court button click handler
    checkCourtBtn.addEventListener('click', () => {
        clearCourtStatus();
        checkCourt();
    });

    // Auto-check court after successful extraction
    const originalShowExtractStatus = showExtractStatus;
    showExtractStatus = function(message, type) {
        originalShowExtractStatus(message, type);
        if (type === 'success' && message.includes('extracted successfully')) {
            // Auto-trigger court check after short delay
            setTimeout(() => {
                checkCourt();
            }, 500);
        }
    };
    </script>
</body>
</html>
